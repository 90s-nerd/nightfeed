<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Nightfeed{% endblock %}</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23f8a366'/%3E%3Cstop offset='62%25' stop-color='%23ec7d3d'/%3E%3Cstop offset='100%25' stop-color='%23c75b21'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='4' y='4' width='56' height='56' rx='18' fill='url(%23g)'/%3E%3Crect x='16' y='17' width='24' height='5' rx='2.5' fill='white'/%3E%3Crect x='16' y='27' width='24' height='5' rx='2.5' fill='white' opacity='.92'/%3E%3Crect x='16' y='37' width='24' height='5' rx='2.5' fill='white' opacity='.84'/%3E%3Crect x='43' y='16' width='5' height='24' rx='2.5' fill='white'/%3E%3C/svg%3E">
    <style>
      :root {
        --bg: #0d121a;
        --bg-soft: #121824;
        --panel: #161d29;
        --panel-2: #1a2230;
        --line: rgba(255, 255, 255, 0.08);
        --line-strong: rgba(255, 255, 255, 0.14);
        --text: #edf2fb;
        --muted: #95a0b3;
        --accent: #f28b4b;
        --accent-strong: #d46f31;
        --accent-soft: rgba(242, 139, 75, 0.14);
        --success: #3fc48a;
        --danger: #eb6c68;
        --shadow: 0 24px 60px rgba(0, 0, 0, 0.28);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        color: var(--text);
        font: 400 15px/1.45 "Avenir Next", "Segoe UI", sans-serif;
        background:
          radial-gradient(circle at top left, rgba(242, 139, 75, 0.12), transparent 20%),
          linear-gradient(180deg, #0a0f16 0%, var(--bg) 100%);
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      button,
      input,
      select,
      textarea {
        font: inherit;
      }

      .app-shell {
        min-height: 100vh;
        display: grid;
        grid-template-columns: 240px minmax(0, 1fr);
      }

      .sidebar {
        background: rgba(15, 20, 29, 0.92);
        border-right: 1px solid var(--line);
        padding: 18px 14px;
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .brand-mark {
        position: relative;
        width: 38px;
        height: 38px;
        border-radius: 14px;
        background: linear-gradient(160deg, #f8a366 0%, #ec7d3d 62%, #c75b21 100%);
        box-shadow: 0 10px 24px rgba(242, 139, 75, 0.22);
        overflow: hidden;
      }

      .brand-mark::before,
      .brand-mark::after {
        content: "";
        position: absolute;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 999px;
      }

      .brand-mark::before {
        width: 18px;
        height: 4px;
        left: 9px;
        top: 10px;
        box-shadow: 0 7px 0 rgba(255, 255, 255, 0.9), 0 14px 0 rgba(255, 255, 255, 0.82);
      }

      .brand-mark::after {
        width: 4px;
        height: 18px;
        right: 9px;
        top: 9px;
      }

      .brand-copy strong {
        display: block;
        font-size: 1rem;
        letter-spacing: -0.03em;
      }

      .brand-copy span {
        display: block;
        margin-top: 2px;
        color: var(--muted);
        font-size: 0.82rem;
      }

      .nav-list {
        display: grid;
        gap: 8px;
      }

      .nav-link {
        display: flex;
        align-items: center;
        gap: 10px;
        min-height: 42px;
        padding: 0 12px;
        border-radius: 12px;
        color: var(--muted);
        border: 1px solid transparent;
      }

      .nav-link.active,
      .nav-link:hover {
        color: var(--text);
        background: rgba(255, 255, 255, 0.04);
        border-color: var(--line);
      }

      .sidebar-footer {
        margin-top: auto;
      }

      .main {
        min-width: 0;
        padding: 18px 22px 28px;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 18px;
      }

      .page-title h1 {
        margin: 0;
        font-size: 1.9rem;
        letter-spacing: -0.04em;
      }

      .page-title p {
        margin: 4px 0 0;
        color: var(--muted);
        font-size: 0.92rem;
      }

      .topbar-actions,
      .button-row,
      .form-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        min-height: 40px;
        padding: 0 14px;
        border-radius: 12px;
        border: 1px solid transparent;
        cursor: pointer;
        transition: transform 140ms ease, background 140ms ease, border-color 140ms ease;
      }

      .btn:hover {
        transform: translateY(-1px);
      }

      .btn:disabled {
        cursor: wait;
        opacity: 0.78;
        transform: none;
      }

      .btn-primary {
        background: var(--accent);
        color: #fff;
      }

      .btn-primary:hover {
        background: var(--accent-strong);
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.04);
        border-color: var(--line);
        color: var(--text);
      }

      .btn-danger {
        background: rgba(235, 108, 104, 0.1);
        border-color: rgba(235, 108, 104, 0.24);
        color: #ffd9d8;
      }

      .surface {
        background: linear-gradient(180deg, rgba(25, 32, 46, 0.94), rgba(18, 24, 36, 0.96));
        border: 1px solid var(--line);
        border-radius: 20px;
        box-shadow: var(--shadow);
      }

      .section {
        padding: 20px;
      }

      .section-head {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 16px;
      }

      .section-kicker {
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 0.72rem;
      }

      .section-head h2 {
        margin: 4px 0 0;
        font-size: 1.2rem;
        letter-spacing: -0.03em;
      }

      .section-head p,
      .meta,
      .empty-state,
      .field label,
      .notice p {
        color: var(--muted);
      }

      .section-head p {
        margin: 6px 0 0;
      }

      .stat-grid,
      .detail-metrics,
      .compose-grid {
        display: grid;
        gap: 12px;
      }

      .compose-grid {
        align-items: start;
      }

      .stat-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .detail-metrics {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }

      .stat-card,
      .metric-card {
        padding: 16px;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--line);
      }

      .metric-label {
        color: var(--muted);
        font-size: 0.8rem;
      }

      .metric-value {
        margin-top: 6px;
        font-size: 1.3rem;
        font-weight: 700;
        letter-spacing: -0.03em;
      }

      .feed-grid {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      }

      .feed-card,
      .item-card,
      .preview-card {
        display: block;
        padding: 18px;
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.025);
        border: 1px solid var(--line);
        transition: transform 140ms ease, border-color 140ms ease;
      }

      .feed-card:hover,
      .item-card:hover {
        transform: translateY(-2px);
        border-color: var(--line-strong);
      }

      .feed-card h3,
      .item-card h3,
      .preview-card h3 {
        margin: 0;
        font-size: 1.02rem;
        letter-spacing: -0.02em;
      }

      .feed-url,
      .meta-row,
      .item-footer,
      .copy-row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }

      .meta-row,
      .item-footer {
        justify-content: space-between;
      }

      .feed-url {
        margin-top: 8px;
        color: var(--muted);
        font-size: 0.9rem;
        word-break: break-all;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        min-height: 28px;
        padding: 0 10px;
        border-radius: 999px;
        background: var(--accent-soft);
        color: #ffc59f;
        font-size: 0.76rem;
      }

      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        min-height: 28px;
        padding: 0 10px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.04);
        font-size: 0.76rem;
        color: var(--muted);
      }

      .status-badge.ok {
        color: var(--success);
        background: rgba(63, 196, 138, 0.1);
        border-color: rgba(63, 196, 138, 0.22);
      }

      .status-badge.error {
        color: var(--danger);
        background: rgba(235, 108, 104, 0.1);
        border-color: rgba(235, 108, 104, 0.22);
      }

      .status-badge.idle {
        color: #c9d2e3;
        background: rgba(149, 160, 179, 0.1);
        border-color: rgba(149, 160, 179, 0.18);
      }

      .status-badge.disabled {
        color: #d1c4a5;
        background: rgba(188, 168, 117, 0.12);
        border-color: rgba(188, 168, 117, 0.22);
      }

      .status-icon {
        width: 16px;
        height: 16px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid currentColor;
        color: currentColor;
        font-size: 0.72rem;
        font-weight: 800;
        line-height: 1;
        flex: 0 0 16px;
      }

      .copy-row {
        margin-top: 18px;
        padding: 14px;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--line);
        justify-content: space-between;
      }

      .copy-meta {
        min-width: 0;
        flex: 1 1 280px;
      }

      .copy-label {
        color: var(--muted);
        font-size: 0.76rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .copy-value {
        margin-top: 4px;
        word-break: break-all;
      }

      .list-stack {
        display: grid;
        gap: 12px;
      }

      .field {
        display: grid;
        gap: 6px;
        margin-bottom: 12px;
      }

      .field label {
        font-size: 0.86rem;
      }

      .field input,
      .field select,
      .field textarea {
        width: 100%;
        min-height: 42px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.03);
        color: var(--text);
      }

      .field textarea {
        min-height: 110px;
        resize: vertical;
        line-height: 1.45;
      }

      .field-hint {
        margin-top: 2px;
        color: var(--muted);
        font-size: 0.8rem;
      }

      .notice-soft {
        margin-top: 16px;
        padding: 16px;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--line);
      }

      .empty-state {
        padding: 18px;
        border-radius: 16px;
        border: 1px dashed var(--line-strong);
        text-align: center;
      }

      .loading-note {
        margin-top: 12px;
        padding: 12px 14px;
        border-radius: 14px;
        border: 1px solid rgba(242, 139, 75, 0.2);
        background: rgba(242, 139, 75, 0.08);
        color: #ffd5b7;
        display: none;
      }

      .loading-note.active {
        display: block;
      }

      .loading-label {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 0.76rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #ffbe92;
      }

      .loading-status {
        margin-top: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .loading-status strong {
        font-size: 0.95rem;
        letter-spacing: -0.02em;
      }

      .loading-status span {
        color: var(--muted);
        font-size: 0.84rem;
      }

      .loading-dots {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        flex: 0 0 auto;
      }

      .loading-dots i {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: rgba(255, 213, 183, 0.34);
        animation: pulse-dot 1.1s ease-in-out infinite;
      }

      .loading-dots i:nth-child(2) {
        animation-delay: 0.16s;
      }

      .loading-dots i:nth-child(3) {
        animation-delay: 0.32s;
      }

      .spinner {
        width: 14px;
        height: 14px;
        border-radius: 999px;
        border: 2px solid rgba(255, 255, 255, 0.28);
        border-top-color: currentColor;
        animation: spin 0.7s linear infinite;
        flex: 0 0 14px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @keyframes pulse-dot {
        0%,
        80%,
        100% {
          opacity: 0.35;
          transform: scale(0.9);
        }

        40% {
          opacity: 1;
          transform: scale(1);
        }
      }

      .notice {
        margin-top: 16px;
        padding: 16px;
        border-radius: 16px;
        background: rgba(235, 108, 104, 0.08);
        border: 1px solid rgba(235, 108, 104, 0.18);
      }

      .error-text {
        margin: 12px 0 0;
        color: #ff9f9d;
      }

      .link-text {
        color: #ffbc8f;
      }

      .inline-form {
        margin: 0;
      }

      @media (max-width: 980px) {
        .app-shell {
          grid-template-columns: 1fr;
        }

        .sidebar {
          border-right: none;
          border-bottom: 1px solid var(--line);
        }

        .stat-grid {
          grid-template-columns: 1fr;
        }

        .compose-grid {
          grid-template-columns: 1fr !important;
        }
      }

      @media (max-width: 720px) {
        .main {
          padding: 16px;
        }

        .topbar,
        .section-head,
        .meta-row,
        .item-footer,
        .copy-row {
          flex-direction: column;
          align-items: stretch;
        }

        .topbar-actions .btn,
        .button-row .btn,
        .button-row form,
        .form-actions .btn {
          width: 100%;
        }

        .button-row form .btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <div class="brand">
          <div class="brand-mark" aria-hidden="true"></div>
          <div class="brand-copy">
            <strong>Nightfeed</strong>
            <span>Site pages into stable RSS.</span>
          </div>
        </div>

        <nav class="nav-list">
          <a class="nav-link {% if request.path == '/' %}active{% endif %}" href="/">My Feeds</a>
        </nav>

        <div class="sidebar-footer">
          <a class="nav-link {% if request.path == '/settings' %}active{% endif %}" href="/settings">Settings</a>
        </div>
      </aside>

      <main class="main">
        {% block page_header %}{% endblock %}
        {% block content %}{% endblock %}
      </main>
    </div>
    <script>
      const previewDebugParams = new URLSearchParams(window.location.search);
      if (previewDebugParams.get("preview_debug") === "1") {
        window.localStorage.setItem("nightfeed.previewDebug", "1");
      } else if (previewDebugParams.get("preview_debug") === "0") {
        window.localStorage.removeItem("nightfeed.previewDebug");
      }

      const previewDebugEnabled = window.localStorage.getItem("nightfeed.previewDebug") === "1";

      const logPreviewDebug = (label, payload) => {
        if (!previewDebugEnabled) {
          return;
        }
        console.log(`[Nightfeed Preview] ${label}`, payload);
      };

      if (previewDebugEnabled) {
        console.log("[Nightfeed Preview] debug mode enabled");
      }

      const setButtonLoadingState = (form, submitter) => {
        if (!submitter || !submitter.dataset.loadingLabel) {
          return;
        }

        const originalLabel = submitter.dataset.originalLabel || submitter.textContent.trim();
        submitter.dataset.originalLabel = originalLabel;
        submitter.disabled = true;
        submitter.innerHTML = '<span class="spinner" aria-hidden="true"></span>' + submitter.dataset.loadingLabel;

        form.querySelectorAll("button").forEach((button) => {
          if (button !== submitter) {
            button.disabled = true;
          }
        });

        const loadingNote = form.parentElement.querySelector("[data-loading-note]");
        if (loadingNote) {
          loadingNote.classList.add("active");
        }
      };

      const stopLoadingStatus = (form) => {
        if (form._previewSource) {
          form._previewSource.close();
          form._previewSource = null;
        }
      };

      const updateLoadingStatus = (form, stage) => {
        const loadingNote = form.parentElement.querySelector("[data-loading-note]");
        if (!loadingNote) {
          return;
        }

        const title = loadingNote.querySelector("[data-loading-title]");
        const detail = loadingNote.querySelector("[data-loading-detail]");
        if (title) {
          title.textContent = stage.title;
        }
        if (detail) {
          detail.textContent = stage.detail;
        }
      };

      const startLoadingStatus = (form) => {
        updateLoadingStatus(form, {
          title: "Connecting",
          detail: "Waiting for the preview stream to start.",
        });
      };

      const resetButtonLoadingState = (form, submitter) => {
        if (!submitter) {
          return;
        }

        const originalLabel = submitter.dataset.originalLabel;
        if (originalLabel) {
          submitter.textContent = originalLabel;
        }

        form.querySelectorAll("button").forEach((button) => {
          button.disabled = false;
        });

        const loadingNote = form.parentElement.querySelector("[data-loading-note]");
        if (loadingNote) {
          loadingNote.classList.remove("active");
        }
        stopLoadingStatus(form);
        updateLoadingStatus(form, {
          title: "Connecting",
          detail: "Waiting for the preview stream to start.",
        });
      };

      const escapeHtml = (value) => String(value)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");

      const renderPreviewItems = (targetName, payload) => {
        const list = document.querySelector(`[data-preview-list="${targetName}"]`);
        if (!list) {
          return;
        }

        const panel = document.querySelector(`[data-preview-panel="${targetName}"]`);
        const count = panel ? panel.querySelector("[data-preview-count]") : null;
        const error = panel ? panel.querySelector("[data-preview-error]") : null;
        const empty = panel ? panel.querySelector("[data-preview-empty]") : null;

        const items = payload.items || [];
        if (count) {
          count.textContent = `${items.length} items found with the current selectors.`;
        }

        if (payload.error) {
          list.hidden = true;
          list.innerHTML = "";
          if (error) {
            error.hidden = false;
            error.textContent = payload.error;
          }
          if (empty) {
            empty.hidden = true;
          }
          return;
        }

        if (error) {
          error.hidden = true;
          error.textContent = "";
        }

        if (!items.length) {
          list.hidden = true;
          list.innerHTML = "";
          if (empty) {
            empty.hidden = false;
          }
          return;
        }

        list.hidden = false;
        if (empty) {
          empty.hidden = true;
        }
        list.innerHTML = items.map((item) => `
          <article class="preview-card">
            <h3>${escapeHtml(item.title)}</h3>
            <p class="meta">${escapeHtml(item.link)}</p>
          </article>
        `).join("");
      };

      const buildPreviewStreamUrl = (baseUrl, form) => {
        const params = new URLSearchParams();
        new FormData(form).forEach((value, key) => {
          params.append(key, value);
        });
        return `${baseUrl}?${params.toString()}`;
      };

      const runPreviewWithSse = (form, submitter) => new Promise((resolve) => {
        const streamUrl = submitter.dataset.previewStreamUrl;
        if (!streamUrl || typeof EventSource === "undefined") {
          resolve(false);
          return;
        }

        const source = new EventSource(buildPreviewStreamUrl(streamUrl, form));
        form._previewSource = source;

        source.addEventListener("stage", (event) => {
          const payload = JSON.parse(event.data);
          logPreviewDebug("stage", payload);
          updateLoadingStatus(form, payload);
        });

        source.addEventListener("result", (event) => {
          const payload = JSON.parse(event.data);
          logPreviewDebug("result", payload);
          renderPreviewItems(submitter.dataset.previewTarget, payload);
        });

        source.addEventListener("error", (event) => {
          let payload = { error: "Preview failed. Try again.", items: [] };
          if (event.data) {
            payload = JSON.parse(event.data);
          }
          logPreviewDebug("error", payload);
          renderPreviewItems(submitter.dataset.previewTarget, payload);
        });

        source.addEventListener("done", () => {
          logPreviewDebug("done", {});
          source.close();
          form._previewSource = null;
          resolve(true);
        });

        source.onerror = () => {
          logPreviewDebug("transport-error", {});
          if (form._previewSource) {
            renderPreviewItems(submitter.dataset.previewTarget, {
              items: [],
              error: "Preview stream disconnected. Try again.",
            });
            source.close();
            form._previewSource = null;
            resolve(true);
          }
        };
      });

      document.querySelectorAll("[data-loading-form]").forEach((form) => {
        form.addEventListener("submit", async (event) => {
          const submitter = event.submitter;
          if (!submitter) {
            return;
          }

          if (form.dataset.loading === "1") {
            event.preventDefault();
            return;
          }

          if (submitter.dataset.previewUrl) {
            event.preventDefault();
            form.dataset.loading = "1";
            setButtonLoadingState(form, submitter);
            startLoadingStatus(form);

            try {
              const usedSse = await runPreviewWithSse(form, submitter);
              if (!usedSse) {
                const response = await fetch(submitter.dataset.previewUrl, {
                  method: "POST",
                  headers: {
                    "X-Requested-With": "XMLHttpRequest",
                  },
                  body: new FormData(form),
                });
                const payload = await response.json();
                renderPreviewItems(submitter.dataset.previewTarget, payload);
              }
            } catch (error) {
              renderPreviewItems(submitter.dataset.previewTarget, {
                items: [],
                error: "Preview failed. Try again.",
              });
            } finally {
              form.dataset.loading = "0";
              resetButtonLoadingState(form, submitter);
            }
            return;
          }

          if (!submitter.dataset.loadingLabel) {
            return;
          }

          form.dataset.loading = "1";
          setButtonLoadingState(form, submitter);
        });
      });
    </script>
  </body>
</html>
